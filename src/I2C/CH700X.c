#include "CH700X.h"
#include "i2c.h"
#include "dependency.h"

#ifdef	USE_DSPIN
	#define DEFAULT_SAV		(0x1c)
#else
	#define DEFAULT_SAV		(64*2+18)
#endif
#define MPEG4_VOUT_MASTER_MODE
#define DEFAULT_HP			(0x06)//(0x2d)
#define DEFAULT_VP			(0x00)//(0xf4)

struct i2c_client ch700x_client;

static int inline
ch700x_write(u8 reg, u8 val)
{
	int ret;
	u8 buf[2];

	buf[0] = reg;
	buf[1] = val;
	ret = i2c_master_send(&ch700x_client, buf, 2);
	if (ret != 2)
		return -1;
	else
		return 0;
}

static int inline
ch700x_read(u8 reg)
{
	int ret;
	struct i2c_msg msg[2];
	u8 buf = reg;
	u8 ret_buf;
	int ret_val;
       
	memset((void *)msg, 0x00, 2*sizeof(struct i2c_msg));
	msg[0].addr = ch700x_client.addr;
	msg[0].buf = &buf;
	msg[0].len = 1;
	
	msg[1].addr = ch700x_client.addr;
	msg[1].flags = I2C_M_RD;
	msg[1].buf = &ret_buf;
	msg[1].len = 1;
	ret = i2c_transfer(msg, 2);
	if (ret != 2)
		return -1;
	ret_val = ret_buf;
	return ret_val;
}

const char		ch7007a_initset[] =		// Reg Addr, set value
{
	CH700X_PMR, CH700X_PMR_RESET | CH700X_PMR_PD_PIN
, CH700X_PMR, CH700X_PMR_NORMAL | CH700X_PMR_PD_PIN 
, CH700X_PMR, CH700X_PMR_NORMAL | CH700X_PMR_PD_PIN 
, CH700X_PLLC, CH700X_PLLC_MEM33V | CH700X_PLLC_PLL5VA | CH700X_PLLC_PLL33VD | CH700X_PLLC_PLLS5 | CH700X_PLLC_640x480_784x600_NTSC
//mark by bacon to test interlace mode
/*
, CH700X_MNE, PLLMNE (CH700X_PLLM_640x480_784x600_NTSC,CH700X_PLLN_640x480_784x600_NTSC)
, CH700X_PLLM, PLLM_7_0 (CH700X_PLLM_640x480_784x600_NTSC)
, CH700X_PLLN, PLLN_7_0 (CH700X_PLLN_640x480_784x600_NTSC)
, CH700X_DMR, CH700X_DMR_640x480_784x600_NTSC
*/    
, CH700X_MNE, PLLMNE (CH700X_PLLM_720x480_858x525_NTSC,CH700X_PLLN_720x480_858x525_NTSC)
, CH700X_PLLM, PLLM_7_0 (CH700X_PLLM_720x480_858x525_NTSC)
, CH700X_PLLN, PLLN_7_0 (CH700X_PLLN_720x480_858x525_NTSC)
, CH700X_DMR, CH700X_DMR_720x480_858x525_NTSC
//, CH700X_DMR,CH700X_DMR_720x576_864x625_PAL
//End of mark by bacon to test interlace mode
, CH700X_FFR, CH700X_FFR_LUMA_MAX | CH700X_FFR_TEXT_MAX | CH700X_FFR_CHROMA_MAX
, CH700X_VBW, CH700X_VBW_YCV_HIGH | CH700X_VBW_YSV_HIGH | CH700X_VBW_YPEAK_ENABLE | CH700X_VBW_CBW_HIGH | CH700X_VBW_CVBW_DISABLE | CH700X_VBW_FLFF_DISABLE
, CH700X_IDF, CH700X_IDF_CCIR656_YCBCR | CH700X_IDF_DACG_NTSC_PALm
#ifdef CONFIG_PC9220
, CH700X_CM, CH700X_CM_PCM_2 | CH700X_CM_XCM_2 | CH700X_CM_MCP_NEG |CH700X_CM_MS_MASTER | CH700X_CM_CFRB_LOOK
#else
, CH700X_CM, CH700X_CM_PCM_2 | CH700X_CM_XCM_2 | CH700X_CM_MCP_POS |CH700X_CM_MS_MASTER | CH700X_CM_CFRB_LOOK
#endif	
, CH700X_CE, CH700X_CE_CONTRAST_NORMAL
//This have order problem must put after PLL
, CH700X_PO, CH700X_PO_VALUE (DEFAULT_SAV, DEFAULT_HP, DEFAULT_VP)
, CH700X_SAV, CH700X_SAV_VALUE (DEFAULT_SAV)
, CH700X_HPR, CH700X_HPR_VALUE (DEFAULT_HP)
, CH700X_VPR, CH700X_VPR_VALUE (DEFAULT_VP)
#ifdef 	MPEG4_VOUT_MASTER_MODE
, CH700X_SPR, CH700X_SPR_HSP_HIGH | CH700X_SPR_VSP_HIGH | CH700X_SPR_SYO_SLAVE |CH700X_SPR_DES_PIN
#else
, CH700X_SPR, CH700X_SPR_HSP_HIGH | CH700X_SPR_VSP_HIGH | CH700X_SPR_SYO_MASTER |CH700X_SPR_DES_PIN
#endif
, CH700X_CIVC, CH700X_CIVC_ACIV_NON
//mark by bacon to test interlace mode
/*
#ifdef 	MPEG4_VOUT_MASTER_MODE
, CH700X_SPR, CH700X_SPR_HSP_HIGH | CH700X_SPR_VSP_HIGH | CH700X_SPR_SYO_SLAVE | CH700X_SPR_DES_PIN
#else
, CH700X_SPR, CH700X_SPR_HSP_HIGH | CH700X_SPR_VSP_HIGH | CH700X_SPR_SYO_MASTER |CH700X_SPR_DES_PIN
#endif
, CH700X_FSCIN (0), CH700X_FSCIN_VALUE (0, CH700X_DMR_640x480_784x600_NTSC_FCSI)
, CH700X_FSCIN (1), CH700X_FSCIN_VALUE (1,CH700X_DMR_640x480_784x600_NTSC_FCSI)
, CH700X_FSCIN (2), CH700X_FSCIN_VALUE (2,CH700X_DMR_640x480_784x600_NTSC_FCSI)
, CH700X_FSCIN (3), CH700X_FSCIN_VALUE (3,CH700X_DMR_640x480_784x600_NTSC_FCSI) | CH700X_FSCI3_GPIOIN1_HIGH | CH700X_FSCI3_GPIOIN0_HIGH | CH700X_FSCI3_DVDD2_33V | CH700X_FSCI3_POUTP_LOW
#ifdef	USE_DSPIN
, CH700X_FSCIN (4), CH700X_FSCIN_VALUE (4, CH700X_DMR_640x480_784x600_NTSC_FCSI) | CH700X_FSCI4_GOENB1_OD | CH700X_FSCI4_GOENB0_OD | CH700X_FSCI4_DSM_DIS | CH700X_FSCI4_DSEN_EN
#else
, CH700X_FSCIN (4), CH700X_FSCIN_VALUE (4, CH700X_DMR_640x480_784x600_NTSC_FCSI) | CH700X_FSCI4_GOENB1_OD | CH700X_FSCI4_GOENB0_OD | CH700X_FSCI4_DSM_DIS | CH700X_FSCI4_DSEN_DIS
#endif
, CH700X_FSCIN (5), CH700X_FSCIN_VALUE (5, CH700X_DMR_640x480_784x600_NTSC_FCSI)
, CH700X_FSCIN (6), CH700X_FSCIN_VALUE (6, CH700X_DMR_640x480_784x600_NTSC_FCSI)
, CH700X_FSCIN (7), CH700X_FSCIN_VALUE (7, CH700X_DMR_640x480_784x600_NTSC_FCSI)
*/
#ifdef 	MPEG4_VOUT_MASTER_MODE
, CH700X_SPR, CH700X_SPR_HSP_HIGH | CH700X_SPR_VSP_HIGH | CH700X_SPR_SYO_SLAVE | CH700X_SPR_DES_PIXEL
#else
, CH700X_SPR, CH700X_SPR_HSP_HIGH | CH700X_SPR_VSP_HIGH | CH700X_SPR_SYO_MASTER | CH700X_SPR_DES_PIXEL
#endif
, CH700X_FSCIN (0), CH700X_FSCIN_VALUE (0, CH700X_DMR_720x480_858x525_NTSC_FCSI)
, CH700X_FSCIN (1), CH700X_FSCIN_VALUE (1, CH700X_DMR_720x480_858x525_NTSC_FCSI)
, CH700X_FSCIN (2), CH700X_FSCIN_VALUE (2, CH700X_DMR_720x480_858x525_NTSC_FCSI)
, CH700X_FSCIN (3), CH700X_FSCIN_VALUE (3, CH700X_DMR_720x480_858x525_NTSC_FCSI) | CH700X_FSCI3_GPIOIN1_HIGH | CH700X_FSCI3_GPIOIN0_HIGH | CH700X_FSCI3_DVDD2_33V | CH700X_FSCI3_POUTP_LOW
#ifdef	USE_DSPIN
, CH700X_FSCIN (4), CH700X_FSCIN_VALUE (4, CH700X_DMR_720x480_858x525_NTSC_FCSI) | CH700X_FSCI4_GOENB1_OD | CH700X_FSCI4_GOENB0_OD | CH700X_FSCI4_DSM_DIS | CH700X_FSCI4_DSEN_EN
#else
, CH700X_FSCIN (4), CH700X_FSCIN_VALUE (4, CH700X_DMR_720x480_858x525_NTSC_FCSI) | CH700X_FSCI4_GOENB1_OD | CH700X_FSCI4_GOENB0_OD | CH700X_FSCI4_DSM_DIS | CH700X_FSCI4_DSEN_DIS
#endif
, CH700X_FSCIN (5), CH700X_FSCIN_VALUE (5, CH700X_DMR_720x480_858x525_NTSC_FCSI)
, CH700X_FSCIN (6), CH700X_FSCIN_VALUE (6, CH700X_DMR_720x480_858x525_NTSC_FCSI)
, CH700X_FSCIN (7), CH700X_FSCIN_VALUE (7, CH700X_DMR_720x480_858x525_NTSC_FCSI)
//End of mark by bacon to test interlace mode
, CH700X_PMR, CH700X_PMR_NORMAL | CH700X_PMR_PD_ON
};

extern int
ch700x_init(int format)
{
	int ret=0,i;
	u8 buf;
	i2c_master_initialize(SOCLE_APB0_I2C0, SOCLE_INTC_I2C0);
	ch700x_client.addr = CH7007A_I2C_CLIENT_ADDR;

	buf=ch700x_read(CH700X_REG_PREFIX|CH700X_VID);
	if(buf != CH7007A_VID)
	{
		printf("!!!!! Error could not find the CH7007A verison ID !!!!! get VID = %x\n",buf);
		return -1;
	}
	printf("I2C Channel get CH7007A verison ID.\n");
		
	printf(" CH7007A : Try initial!\n");
 	
	for(i=0;i<sizeof(ch7007a_initset);i=i+2)
	{		
		ret |= ch700x_write(CH700X_REG_PREFIX|ch7007a_initset[i],ch7007a_initset[i+1]);
#ifdef VOP_DBG
		printf("CH7007A Reg(");
		printf("%x",ch7007a_initset[i]);
		printf(") Set Data(");
		printf("%x",ch7007a_initset[i+1]);	
		printf(")\n");
#endif		
	}

//for read back regs
#ifdef VOP_DBG
	for(i=2;i<sizeof(ch7007a_initset);i=i+2)
	{
		printf("CH7007A Reg(");
		printf("%x",ch7007a_initset[i]);		
		printf(") Read Back Data(");
		printf("%x",ch700x_read(ch7007a_initset[i]));
		printf(")\n");		
	}
#endif

	if(format==FORMAT_PAL)
		ret |= ch700x_write(CH700X_REG_PREFIX|CH700X_DMR,CH700X_DMR_720x576_864x625_PAL);
	printf(" CH7007A : initial end!\n");
	return ret;
}
